'use strict';

(function () {
    function plugin(tinymce) {
        tinymce.PluginManager.add('glossarylink', function (editor) {
            editor.ui.registry.addButton('glossarylink', {
                icon: 'bookmark',
                tooltip: 'Select Glossary Item',
                onAction: function () {
                    var angularElement = angular.element(document.querySelector('[ng-controller]'));
                    var injector = angularElement.injector();
                    var editorService = injector.get('editorService');
                    var contentResource = injector.get('contentResource');

                    var selectedText = editor.selection.getContent({ format: 'text' }).trim();

                    if (!selectedText) {
                        alert('Please select a word or phrase first');
                        return;
                    }

                    editorService.contentPicker({
                        multiPicker: false,
                        submit: function (model) {
                            var selectedNode = model.selection[0];

                            contentResource.getById(selectedNode.id).then(function (content) {
                                var definition = '';

                                if (content.variants && content.variants[0]) {
                                    content.variants[0].tabs.forEach(function (tab) {
                                        if (tab.properties) {
                                            tab.properties.forEach(function (prop) {
                                                if (prop.alias === 'definition') {
                                                    var rawValue = prop.value;

                                                    if (typeof rawValue === 'string') {
                                                        var tempDiv = document.createElement('div');
                                                        tempDiv.innerHTML = rawValue;
                                                        definition = tempDiv.textContent || tempDiv.innerText || '';
                                                    } else if (rawValue && typeof rawValue === 'object') {
                                                        if (rawValue.markup) {
                                                            var tempDiv = document.createElement('div');
                                                            tempDiv.innerHTML = rawValue.markup;
                                                            definition = tempDiv.textContent || tempDiv.innerText || '';
                                                        }
                                                    }
                                                }
                                            });
                                        }
                                    });
                                }

                                definition = definition.trim().replace(/"/g, '&quot;').replace(/\n/g, ' ').replace(/\s+/g, ' ');

                                var editorContent = editor.getContent();

                                var glossarySpan = '<span class="glossary-term" ' +
                                    'data-glossary-id="' + selectedNode.id + '" ' +
                                    'data-glossary-name="' + selectedNode.name.replace(/"/g, '&quot;') + '" ' +
                                    'data-glossary-definition="' + definition + '">' +
                                    selectedText + '</span>';

                                var tempContent = editorContent;
                                var placeholder = '___GLOSSARY_PLACEHOLDER___';

                                var existingTerms = [];
                                tempContent = tempContent.replace(/<span class="glossary-term"[^>]*>.*?<\/span>/gi, function (match) {
                                    existingTerms.push(match);
                                    return placeholder + (existingTerms.length - 1) + placeholder;
                                });

                                var wordRegex = new RegExp('\\b(' + selectedText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')\\b', 'gi');
                                tempContent = tempContent.replace(wordRegex, glossarySpan);

                                existingTerms.forEach(function (term, index) {
                                    tempContent = tempContent.replace(placeholder + index + placeholder, term);
                                });

                                // Set content and force sync
                                editor.setContent(tempContent);

                                // IMPORTANT: Force the editor to sync with Umbraco's form
                                editor.save();

                                // Trigger change event to notify Umbraco
                                editor.fire('change');

                                // Also trigger blur to ensure form picks up changes
                                editor.fire('blur');

                                editorService.close();
                            });
                        },
                        close: function () {
                            editorService.close();
                        }
                    });
                }
            });

            editor.ui.registry.addButton('glossaryclear', {
                icon: 'remove',
                tooltip: 'Clear Glossary Selection',
                onAction: function () {

                    var dom = editor.dom;
                    var selection = editor.selection;
                    var node = selection.getNode();
                    var selectedText = selection.getContent({ format: 'text' }).trim();

                    // Work on a string copy of the HTML instead of DOM-only
                    var html = editor.getContent();

                    if (selectedText) {
                        // 1) Clear ALL glossary terms whose text matches the selection
                        var container = document.createElement('div');
                        container.innerHTML = html;

                        container.querySelectorAll('span.glossary-term').forEach(function (span) {
                            var spanText = (span.textContent || span.innerText || '').trim();
                            if (spanText.toLowerCase() === selectedText.toLowerCase()) {
                                // unwrap span
                                var parent = span.parentNode;
                                while (span.firstChild) {
                                    parent.insertBefore(span.firstChild, span);
                                }
                                parent.removeChild(span);
                            }
                        });

                        html = container.innerHTML;
                    } else {
                        // 2) If no selection but cursor is inside a glossary term → clear that one
                        var glossarySpan = dom.getParent(node, 'span.glossary-term');
                        if (glossarySpan) {
                            dom.remove(glossarySpan, true);
                            html = editor.getContent();
                        } else {
                            // 3) No selection and not inside a term → clear ALL glossary terms
                            var containerAll = document.createElement('div');
                            containerAll.innerHTML = html;

                            containerAll.querySelectorAll('span.glossary-term').forEach(function (span) {
                                var parent = span.parentNode;
                                while (span.firstChild) {
                                    parent.insertBefore(span.firstChild, span);
                                }
                                parent.removeChild(span);
                            });

                            html = containerAll.innerHTML;
                        }
                    }

                    // Set content and force sync to Umbraco model
                    editor.setContent(html);          // replaces editor DOM
                    editor.selection.collapse(false); // avoid weird selections
                    editor.undoManager.add();         // add undo level
                    editor.save();                    // update underlying textarea / model
                    editor.fire('change');            // notify Umbraco of change
                }
            });



        });
    }
    plugin(tinymce);
})();
